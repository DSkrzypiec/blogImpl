---
date: "2021-04-11"
tags: ["C#"]
title: "Iterators in C#"
toc: false
draft: true
---

## Intro
Main goal of this post is to present how iterators actually works in C#. In
particular we will take a look on
[IL](https://en.wikipedia.org/wiki/Common_Intermediate_Language) generated by
the compiler to check out what is really going on.

But first let's start from loosely stated definition of iterators in C#.
An _iterator_ is a method or property which returns `IEnumerable<T>` or
`IEnumerator<T>` and uses `yield return` or `yield break` contextual keywords.
One could ask what is then a difference between an iterator and a method that
returns `IList<T>` which also satisfies `IEnumerable<T>` interface? The main
difference is the way of consumption of those sequences. In case of `IList<T>`
actual memory is allocated for all elements. In case of iterators we are
dealing with so-called lazy evaluation. Object from the sequence is taken only
when it's needed.

To express this difference let's consider the following silly example:

```
public IEnumerable<int> PrepareNumbers(int n)
{
    var numbers = new List<int>(n);

    for (var i = 0; i < n; i++) {
        numbers.Add(i + 13);
    }

    return numbers;
}

public IEnumerable<int> GenerateNumbers(int n)
{
    for (var i = 0; i < n; i++) {
        yield return i + 13;
    }
}
```

```
const int size = int.MaxValue;

var numbers1 = PrepareNumbers(size);
var numbers2 = GenerateNumbers(size);

```

Method `PrepareNumbers` allocates in this case over two billions `int`s so it
should throw `System.OutOfMemoryException` on systems with `8GB` of RAM or
smaller. But that is not a case for `GenerateNumbers` because iterator doesn't
perform any allocation for their elements. How C# compiler is doing that? There
can be (almost) any C# code within the iterator method. So how in fact C#
compiler know how to prepare the sequence without preallocation? Let's found
out.


## Details of yield return

## File iterator

## Linq

## References

1. ["C# In Depth" - Jon Skeet](https://www.manning.com/books/c-sharp-in-depth-fourth-edition)
